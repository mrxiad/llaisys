# LLAISYS 作业3 笔记（Qwen2 推理）

完成时间：2026-02-18

## 1. 目标

完成作业3要求的 Qwen2 后端推理链路：

- C/C++ 后端实现模型创建、权重加载、状态重置、单步推理
- Python ctypes 封装与 `python/llaisys/models/qwen2.py` 包装
- 支持 KV cache 增量推理
- 生成接口可用于 `test/test_infer.py` 的 argmax 采样路径

## 2. 主要实现

### 2.1 新增 Qwen2 C API

文件：`include/llaisys/models/qwen2.h`

新增/完善接口：

- `llaisysQwen2ModelCreate`
- `llaisysQwen2ModelDestroy`
- `llaisysQwen2ModelLoadTensor`
- `llaisysQwen2ModelReset`
- `llaisysQwen2ModelInfer`

说明：

- `llaisysQwen2ModelLoadTensor` 按名字加载 safetensors 权重
- `llaisysQwen2ModelInfer` 输入当前完整 token 序列，输出下一个 token（argmax）

### 2.2 后端 Qwen2 推理实现（含 KV cache）

文件：`src/llaisys/qwen2.cc`

实现内容：

- 模型元信息与权重存储
- 按层解析并加载命名权重（含 `q/k/v/o`、`rmsnorm`、`mlp`）
- dtype 自动转换加载（`f32/f16/bf16` 之间）
- KV cache 动态扩容与旧缓存迁移
- 前缀一致性判断（前缀命中时仅计算未缓存后缀）
- 单 token decoder step：
  - embedding
  - attention rmsnorm
  - q/k/v linear
  - rope
  - self-attention（读历史 KV）
  - o_proj + 残差
  - mlp rmsnorm + gate/up/down + 残差
  - final norm + lm_head + argmax

### 2.3 Python ctypes 封装

新增文件：`python/llaisys/libllaisys/models_qwen2.py`

实现内容：

- `LlaisysQwen2Meta` 结构体定义
- Qwen2 C API `argtypes/restype` 注册

并更新：

- `python/llaisys/libllaisys/__init__.py`
  - 加载 `load_qwen2`
  - 导出 `LlaisysQwen2Meta`

### 2.4 Python 高层模型包装

文件：`python/llaisys/models/qwen2.py`

实现内容：

- 读取 `config.json` 并构建 `LlaisysQwen2Meta`
- 遍历 `*.safetensors`，按名字调用 `llaisysQwen2ModelLoadTensor`
- `generate` 中调用 `reset + infer` 进行逐步生成
- 当前按作业3测试需求采用 greedy(argmax) 路径

## 3. 注释与可维护性

本次对关键路径补充了注释，重点覆盖：

- KV cache 结构与扩容迁移逻辑
- prefix reuse（仅计算未缓存后缀）的判定逻辑
- decoder step 关键算子流程
- Python 侧接口行为（argmax 路径与参数兼容）

## 4. 编译与安装

执行：

```bash
xmake -v
xmake install -v
./.venv310/bin/pip install ./python/
```

## 5. 测试结果

### 5.1 作业2算子回归（防止破坏已有实现）

执行并通过：

```bash
./.venv310/bin/python test/ops/add.py --device cpu
./.venv310/bin/python test/ops/argmax.py --device cpu
./.venv310/bin/python test/ops/embedding.py --device cpu
./.venv310/bin/python test/ops/linear.py --device cpu
./.venv310/bin/python test/ops/rms_norm.py --device cpu
./.venv310/bin/python test/ops/rope.py --device cpu
./.venv310/bin/python test/ops/self_attention.py --device cpu
./.venv310/bin/python test/ops/swiglu.py --device cpu
./.venv310/bin/python test/test_tensor.py
./.venv310/bin/python test/test_runtime.py --device cpu
```

全部通过。

### 5.2 作业3链路冒烟测试（本地最小模型）

使用临时最小配置（自建 `config.json + model.safetensors`）验证：

- `llaisys.models.Qwen2(...)` 可创建
- 权重可加载
- `generate(...)` 可完成多步输出

结果：`SMOKE_PASS`

### 5.3 真实模型对齐测试（`test/test_infer.py`）

使用本地缓存的 DeepSeek 模型快照，执行：

```bash
./.venv310/bin/python test/test_infer.py \
  --model /home/mrxiad/.cache/huggingface/hub/models--deepseek-ai--DeepSeek-R1-Distill-Qwen-1.5B/snapshots/ad9f0ae0864d7fbcd1cd905e3c6c5b069cc8b562 \
  --test --max_steps 1 --prompt "Hi"
```

结果：

- LLAISYS token 输出与 PyTorch 完全一致
- 脚本最终输出 `Test passed!`

## 6. 修改文件

- `include/llaisys/models/qwen2.h`
- `src/llaisys/qwen2.cc`
- `python/llaisys/libllaisys/models_qwen2.py`
- `python/llaisys/libllaisys/__init__.py`
- `python/llaisys/models/qwen2.py`
- `作业3.md`

## 7. 完成状态

- [x] Qwen2 后端 C API
- [x] Python ctypes 封装
- [x] Python 模型包装
- [x] KV cache 增量推理
- [x] 代码关键路径注释
- [x] 回归测试 + 冒烟测试
