# LLAISYS 项目1笔记（CPU 优化）

完成时间：2026-02-19

## 1. 目标

按 `Project #1` 要求优化 CPU 推理性能，并给出可复现实测结果。
本次优先优化最耗时算子 `linear`（矩阵乘法核心路径）。

## 2. 实现改动

修改文件：

- `src/ops/linear/op.cpp`

优化点：

- 增加按计算量自适应的多线程并行（`std::thread` 按行切分）。
- 增加 `f32` 快路径（去掉通用 cast 额外开销）。
- `f32` 内积循环做 8-way 展开，提升编译器向量化和流水效率。
- 小规模矩阵保持单线程，避免线程创建开销反噬。

## 3. 性能测试方法

测试环境：

- 设备：CPU
- 张量形状：`(512, 4096) x (4096, 4096)`，带 bias
- 对比对象：`torch.nn.functional.linear` vs `llaisys.Ops.linear`
- 采用同一脚本分别记录优化前/后平均耗时

测试命令（已在本地执行）：

```bash
export PYTHONPATH=python:test
./.venv310/bin/python <benchmark_script>
```

## 4. 性能结果（优化前 vs 优化后）

- `f32`: `6400.601 ms -> 887.498 ms`（约 `7.21x` 提升，耗时下降 `86.13%`）
- `f16`: `27699.066 ms -> 4792.666 ms`（约 `5.78x` 提升，耗时下降 `82.70%`）
- `bf16`: `25854.283 ms -> 3512.621 ms`（约 `7.36x` 提升，耗时下降 `86.41%`）

## 5. 正确性校验

为避免长时间全量测试，执行了 `linear` 轻量数值校验（`f32/f16/bf16` 各一组），
结果均通过 `check_equal`。

## 6. 完成状态

- [x] 完成 CPU 关键算子（`linear`）优化
- [x] 给出优化前后性能数据与提升比例
- [x] 完成基础正确性回归校验
