# LLAISYS 作业2 笔记（算子）

完成时间：2026-02-10

## 1. 目标

实现作业2要求的 CPU 算子，并通过 `test/ops` 下全部测试：

- `argmax`
- `embedding`
- `linear`
- `rms_norm`
- `rope`
- `self_attention`
- `swiglu`

另外补了可选 `rearrange` 的基础实现（连续张量拷贝）。

## 2. 主要实现

### 2.1 通用实现策略

- 当前作业阶段统一支持 CPU 路径。
- 对每个算子增加了：
  - 设备一致性检查
  - dtype 检查
  - shape 检查
  - contiguous 检查
- 计算过程中统一用 `utils::cast<float>(x)` 做中间精度，最后再 cast 回输出 dtype，以支持 `f32/f16/bf16`。

### 2.2 各算子实现说明

#### `argmax`

- 输入暂按 1D 张量处理。
- 输出：`max_idx`（`int64`）和 `max_val`（与输入同 dtype）。
- 线性扫描取最大值与索引。

文件：`src/ops/argmax/op.cpp`

#### `embedding`

- `index` 为 1D `int64`。
- `weight` 为 2D，`out` 为 2D。
- 逐 index 行拷贝（`memcpy`）到输出。

文件：`src/ops/embedding/op.cpp`

#### `linear`

- 计算 `Y = XW^T + b`。
- `in/out/weight` 均按 2D contiguous 处理。
- 支持 `bias` 为空（可选）。

文件：`src/ops/linear/op.cpp`

#### `rms_norm`

- 按行计算 RMS：
  - `mean = sum(x^2)/d`
  - `inv_rms = 1/sqrt(mean + eps)`
  - `out = x * inv_rms * weight`

文件：`src/ops/rms_norm/op.cpp`

#### `rope`

- 输入/输出形状 `[seqlen, nhead, d]`。
- `pos_ids` 为 `[seqlen]`，`int64`。
- 按公式对向量前后半维做旋转。

文件：`src/ops/rope/op.cpp`

#### `self_attention`

- 支持形状：
  - `q: [qlen, nh, d]`
  - `k: [kvlen, nkvh, d]`
  - `v: [kvlen, nkvh, dv]`
  - `attn_val: [qlen, nh, dv]`
- 支持 GQA（`nh % nkvh == 0`）。
- 使用 causal mask（与测试脚本对齐的对角偏移逻辑）。
- 采用稳定 softmax（减 max 再 exp）。

文件：`src/ops/self_attention/op.cpp`

#### `swiglu`

- 逐元素：`up * (gate / (1 + exp(-gate)))`

文件：`src/ops/swiglu/op.cpp`

#### `rearrange`（可选）

- 先实现 contiguous 到 contiguous 的数据搬运。

文件：`src/ops/rearrange/op.cpp`

## 3. 额外兼容修复

### 3.1 `linear` 的 `bias=None` 链路

Python `Ops.linear` 可能传 `None`，若不处理会在 C++ 侧空指针解引用。

已修复：

- Python 侧传空指针：`python/llaisys/ops.py`
- C API 侧判空再转发：`src/llaisys/ops.cc`

## 4. 编译与安装

执行：

```bash
xmake -v
xmake install -v
./.venv310/bin/pip install ./python/
```

说明：

- 需要 `pip install ./python/`，确保虚拟环境里 `llaisys` 使用的是最新 `.so`。

## 5. 测试结果

执行并通过：

```bash
./.venv310/bin/python test/ops/add.py --device cpu
./.venv310/bin/python test/ops/argmax.py --device cpu
./.venv310/bin/python test/ops/embedding.py --device cpu
./.venv310/bin/python test/ops/linear.py --device cpu
./.venv310/bin/python test/ops/rms_norm.py --device cpu
./.venv310/bin/python test/ops/rope.py --device cpu
./.venv310/bin/python test/ops/self_attention.py --device cpu
./.venv310/bin/python test/ops/swiglu.py --device cpu
```

全部输出 `Test passed!`。

并补充回归验证：

```bash
./.venv310/bin/python test/test_tensor.py
./.venv310/bin/python test/test_runtime.py --device cpu
```

均通过。

## 6. 修改文件

- `src/ops/argmax/op.cpp`
- `src/ops/embedding/op.cpp`
- `src/ops/linear/op.cpp`
- `src/ops/rms_norm/op.cpp`
- `src/ops/rope/op.cpp`
- `src/ops/self_attention/op.cpp`
- `src/ops/swiglu/op.cpp`
- `src/ops/rearrange/op.cpp`
- `src/llaisys/ops.cc`
- `python/llaisys/ops.py`

## 7. 完成状态

- [x] 任务 2.1 `argmax`
- [x] 任务 2.2 `embedding`
- [x] 任务 2.3 `linear`
- [x] 任务 2.4 `rms_norm`
- [x] 任务 2.5 `rope`
- [x] 任务 2.6 `self_attention`
- [x] 任务 2.7 `swiglu`
- [x] 任务 2.8 算子测试全部通过
- [x] 任务 2.9（可选）`rearrange` 基础实现

