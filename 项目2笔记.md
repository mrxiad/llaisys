# LLAISYS 项目2笔记（NVIDIA/CUDA，真实设备测试）

完成时间：2026-02-19

## 1. 结论

- 这不是作业编号（`Assignment #0~#3`），而是 `Project #2: Integrate CUDA into LLAISYS`。
- 当前实现已经在真实 NVIDIA GPU 上跑通（`RTX 3060 Laptop`, `device_count=1`）。
- `runtime + 8 个算子` 均通过 `--device nvidia` 测试，执行路径为 CUDA kernel，不是 CPU 回退。
- 按低磁盘策略完成：保留 `torch==2.4.1+cpu`，不安装 CUDA 版 PyTorch 大包。

## 2. 本次实现

### 2.1 NVIDIA Runtime API

文件：

- `src/device/nvidia/nvidia_runtime_api.cpp`
- `src/device/nvidia/nvidia_resource.cpp`

内容：

- 实现 `cudaGetDeviceCount / cudaSetDevice / cudaDeviceSynchronize`
- 实现 stream、malloc/free、host pin memory、sync/async memcpy
- 完整 CUDA 错误检查并抛异常

### 2.2 构建系统（xmake）

文件：

- `xmake.lua`
- `xmake/nvidia.lua`

内容：

- 新增 NVIDIA 设备与算子目标
- 增加 CUDA 依赖与链接设置
- 解决 `__cudaRegisterLinkedBinary...` 问题：启用 CUDA `devlink` 并补 `-fPIC` 到设备链接阶段

### 2.3 NVIDIA 算子实现（真实 CUDA kernel）

文件：

- `src/ops/nvidia/op_nvidia.cu`
- `src/ops/nvidia/op_nvidia.hpp`

覆盖算子：

- `add`
- `argmax`
- `embedding`
- `linear`
- `rms_norm`
- `rope`
- `self_attention`
- `swiglu`

分发改造：

- `src/ops/*/op.cpp` 在 `LLAISYS_DEVICE_NVIDIA` 分支直接调用 `nvidia::...`
- 已去除此前的 CPU fallback 方案

## 3. 低磁盘测试策略

文件：

- `test/test_utils.py`
- `python/llaisys/__init__.py`

说明：

- 允许 `--device nvidia` 时使用 CPU Torch 作为参考（不要求安装 CUDA Torch）
- 根据源/目标自动选择 `H2D/D2H/D2D/H2H` memcpy kind
- 对 “CUDA 结果 vs CPU Torch 参考” 的 `f32` 比较，适度放宽到 `2e-4`，避免三角函数库差异导致的误报
- `llaisys` 顶层改为可选导入 `models`，避免未装 `safetensors` 时阻塞算子测试

## 4. 构建与测试命令

```bash
xmake f --nv-gpu=y -m release
xmake -j 8
xmake install -o .

export PYTHONPATH=python:test
./.venv310/bin/python test/test_runtime.py --device nvidia
./.venv310/bin/python test/ops/add.py --device nvidia
./.venv310/bin/python test/ops/argmax.py --device nvidia
./.venv310/bin/python test/ops/embedding.py --device nvidia
./.venv310/bin/python test/ops/linear.py --device nvidia
./.venv310/bin/python test/ops/rms_norm.py --device nvidia
./.venv310/bin/python test/ops/rope.py --device nvidia
./.venv310/bin/python test/ops/self_attention.py --device nvidia
./.venv310/bin/python test/ops/swiglu.py --device nvidia
```

结果：全部通过。

## 5. 磁盘占用结论

- 当前磁盘空闲约 `913G`
- `~/.cache/pip` 约 `1.6M`
- 未下载 CUDA 版 PyTorch 依赖（通常可节省约 `2~6GB`）

## 6. 完成状态

- [x] Project #2 NVIDIA Runtime API
- [x] Project #2 NVIDIA 构建接入
- [x] Project #2 CUDA kernel（8 ops）
- [x] NVIDIA 路径测试全通过（runtime + 8 ops）
- [x] 低磁盘方案（CPU Torch 参考，不下载 CUDA Torch）
